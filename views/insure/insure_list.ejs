<%- include('../header') %>

<div id="content" class="whp100 patNot">

	<div class="border regis-tle-box shadow-sm">
		<h5 class="regis-tle">
			<i class="fas fa-edit" style="color:#777;font-size:16px;"></i>&nbsp;&nbsp;여행자보험 관리 &nbsp;&nbsp;
			<span style="color:#bbb; font-size:14px;" id="totCount">(0) </span>
		</h5>
	</div>

	<form name="frmSearch" id="frmSearch"  method="post" onsubmit="return formSearch(event);" >
	<input type="hidden" name="menuCol"   value="">
    <input type="hidden" name="mode"      value="">
	<input type="hidden" name="page"      value="1">
		<div id="searchFrame">
			<div class="row">
                <div class="col-3">
					<button type="button" class="btn btn-yellow " href="javascript://"  onClick="newReg()"><i class="fas fa-project-diagram" style="font-size:0.8em;"></i>&nbsp;&nbsp;신규등록</button>
				</div>
				<div class="col-9 mt-3" >
					<div class="row float-right">
						
						
						<div class="d-inline_ mr-2 none">
							<div class='custom-control custom-checkbox mr-2 d-inline'>
								<input class='custom-control-input' type='checkbox' name='cancel' id='cancel' value='Y'  ><label class="custom-control-label mb-2" for='cancel'>취소포함</label>
							</div>
						</div>
						
						<div class="d-inline mr-2">
							<span class="d-inline mt-1"><i class="fas fa-bars" style='padding-top:2px'></i>&nbsp;줄수&nbsp;</span>
							<input type="text" name="listCount" class="d-inline form-control form-control-sm wh40" value="20" style='width:30px;'>
						</div>
						<div class="d-inline mr-2">
							<span class="d-inline mt-1"></span>
							<input name='start_date' id='start_date' type='text' autocomplete="off" class='d-inline form-control form-control-sm wh100'  onClick="return datePick('start_date')">
							&nbsp;<i class='fas fa-calendar-alt' onClick="return datePick('start_date')" style='color:#555;'></i>
							
						</div>
						<div class="d-inline mr-3">
							<span class="d-inline mt-1"></span>
							<input name='end_date' id='end_date' type='text' autocomplete="off" class='d-inline form-control form-control-sm wh100' onClick="return datePick('end_date')">
							&nbsp;<i class='fas fa-calendar-alt' onClick="return datePick('end_date')" style='color:#555;'></i>
							
						</div>
                        <div class="d-inline mr-2">
                            <select name="GU4" class="d-inline form-control form-control-sm"  >
                                <option value=''>상태</option>
                                <option value='1'>대기</option>
                                <option value='2'>접수</option>
                                <option value='3'>완료</option>
                                <option value='8'>환불</option>
                                <option value='9'>취소</option>
                                <option value='E'>오류</option>
                            </select>
                        </div>
                        <div class="d-inline mr-2">
                            <select name="GU3" class="d-inline form-control form-control-sm"  >
                                <option value="start_day"		>출발일</option>
                                <option value="arrive_day"		>귀국일</option>
                                <option value="order_date"		>등록일</option>
                            </select>
                        </div>
						<div class="d-inline mr-2">
                            <select name="sFrom" class="d-inline form-control form-control-sm"  >
                                <option value='a.uid'			>접수번호</option>
                                <option value='a.site_code'		>거래처코드</option>
                                <option value='c.kname'			>보험가입자</option>
                            </select>
                        </div>
						<div class="d-inline mr-3">
							<div class="input-group">
                                <input name="sWord" class="form-control form-control-sm py-2" style="line-height:10px;width:100px;"  placeholder="검색" id="example-search-input">
                                <span class="input-group-append">
                                <button class="btn btn-dark" type="submit" style="background-color:#555;" >
                                    <i class="fa fa-search"></i>
                                </button>
                                </span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>

	<form name="frmForm" method="post" id="frmForm">
	<input type="hidden" name="uid"  value="">
	<input type="hidden" name="mode" value="">
	<div ID="listFrame" >
		<div ID="listFrameSub" >
			<table class='table table-light text-center mt-3' bordercolor='#ddd' style="border-bottom:1px solid #ddd;" id='dtBasic'>
				<tr style="background-color:#eee;">
                    <th class='start' style='font-size:13px'>No</th>
                    <th style='font-size:13px'>상태</th>
                    <th style='font-size:13px'>거래처</th>
                    <th style='font-size:13px'>출발일</th>
                    <th style='font-size:13px'>귀국일</th>
                    <th style='font-size:13px'>여행지</th>
                    <th style='font-size:13px'>등록일</th>
                    <th style='font-size:13px'>실손여부</th>
                    <th style='font-size:13px'>총인원</th>
                    <th style='font-size:13px'>성인</th>
                    <th style='font-size:13px'>아동</th>
                    <th style='font-size:13px'>유아</th>
                    <th style='font-size:13px'>총 보험료</th>
                    <th style='font-size:13px'>Tasf</th>
                    <th style='font-size:13px'>주문번호</th>
				</tr>
				
			</table>
		</div>
	</div>
	</form>
	<div style="clear:both;" ID="bottomFrame">

		<div class="whp33 fl">
			&nbsp;
			
		</div>
		<div class="whp33 fl ac" ID="pagingHTML">
		</div>
		<div class="row float-right mr-0 fr">			
			<button class="btn_basic btn-gray "     href="javascript://" onClick="return excelDown()" >엑셀다운</button>
		</div>
		
	</div>

</div>
<form name="frmModify" id="frmModify" method="post" >
	<input type="hidden" name="mode"		value="">
	<input type="hidden" name="uid">
	<input type="hidden" name="money_type">
    <input type="hidden" name="gubun_code">

</form>
<div id="basePopUp" style="display:none"></div>
<script type="text/javascript">
<!--

    async function newReg (uid='',mode='input') {
        frmModify.uid.value      = uid;
        frmModify.mode.value     = mode;
        LoadingStart ();
        json = await dataSaveSend ('frmModify','/insure/insureSave');
		const title   = json.title;
		const html    = json.html;
        const name    = json.name;
		drawer.open(1300, { title, html  });
        LoadingStop();
        
	}

	$(document).ready(function() {
		//frmSearch.submit ();
		formSearch (event,'1');
	});
    async function formSearch (e,page=1) {
        if (e) e.preventDefault();
        frmSearch.page.value = page;
		LoadingStart ();
        json = await dataSaveSend ('frmSearch','/insure/insure_list');
		const success = json.success;
		if (success === "ok") {
            const datas  = json.listData;
            const paging = json.pageData;
            $("#listFrameSub").html(datas);
            $("#pagingHTML").html(paging);
			$("#totCount").html(`(${json.totalCount})`);
		} else {
            newAlert('목록호출중 오류 발생');
		}
		LoadingStop();
        return false;
	};

    async function inputCheck () {
        Obj = document.frmDetail;
		if(Obj.site_code.value == ""){
			alert("거래처코드를 선택해 주세요");
		} else {
            const json = await dataSaveSend ('frmDetail','/insure/insureSave');
            const success  = json.success;
            const errorMsg = json.errorMsg;
            const uid      = json.uid;
            if (success === "ok") {
                formSearch(event,frmSearch.page.value);
                drawer.close();
            } else {
                newAlert('에러:'+errorMsg);
            }
		}
		return false;
	}

    function setSiteName(code) {
        const options = document.querySelectorAll('#site_code option');
        let name = '';

        for (const opt of options) {
            if (opt.value === code) {
                name = opt.textContent.trim();
                break;
            }
        }

        // siteName div 업데이트
        document.getElementById('siteName').innerText = name;
    }

    function sChange (minor) {
		const val = $("#tjumin2_"+minor).val();
		let   sex = val.slice(0,1);
		if (sex === "1" || sex === "3") sex = "m";
		else sex = "w";
		$("#tsex_"+minor).val(sex).prop('selected', true);
	}

	async function insure_cal(){
		const Obj = document.frmDetail;
		
		if(Obj.site_code.value == "" ){
			alert("신청여행사를 입력하세요.");
			return false;
		}else if(Obj.adult_member.value < 1 ){
			alert("인원을 확인해 주세요");
			return false;
		}else if(Obj.country.value == "" ){
			alert("여행국가를 확인해주세요");
			return false;
		}else if(Obj.start_day.value == "" ){
			alert("출발일을 선택해주세요.");
			return false;
		}else if(Obj.arrive_day.value == "" ){
			alert("귀국일을 선택해주세요.");
			return false;
		}else if( StrClear(Obj.start_day.value) >= StrClear(Obj.arrive_day.value) ){
			alert("귀국일을 확인해주세요.");
			return false;
		}

		const members = Number(Obj.adult_member.value) + Number(Obj.child_member.value) + Number(Obj.infant_member.value);
		for(let i = 1; i<= members; i++){
			if($("#tkname_"+i).val() == ''){
				alert('이름을 입력해주세요. ');
				return false;
			}else if($("#tjumin_"+i).val().length != 6){
				alert('생년월일 6자리 확인해주세요. ');
				return false;
			}
		}
		
		if (!Obj.mode) {
			alert("폼 오류가 발생했습니다. 페이지를 새로고침해주세요.");
			return false;
		}
		
		Obj.mode.value = "cal";
		LoadingStart();
		
		try {
			const json = await dataSaveSend ('frmDetail','/insure/insureSave');
			if (!json) {
				newAlert('서버 응답 오류가 발생했습니다.');
				return false;
			}
			const success = json.success;
			if (success === "ok") {
				drawer.close();
			} else {
				newAlert('에러:'+ (json.errorMsg || '알 수 없는 오류'));
			}
		} catch (error) {
			console.error('insure_cal error:', error);
			newAlert('보험료 계산 중 오류가 발생했습니다.');
		} finally {
			LoadingStop();
		}
		return false;
	}

	async function insure_del(){
		const Obj = document.frmDetail;
		
		if (!Obj || !Obj.mode) {
			alert("폼 오류가 발생했습니다. 페이지를 새로고침해주세요.");
			return false;
		}
		
		Obj.mode.value = "insureReset";
		LoadingStart();
		
		try {
			const json = await dataSaveSend ('frmDetail','/insure/insureSave');
			if (!json) {
				newAlert('서버 응답 오류가 발생했습니다.');
				return false;
			}
			const success = json.success;
			if (success === "ok") {
				drawer.close();
			} else {
				newAlert('에러:'+ (json.errorMsg || '알 수 없는 오류'));
			}
		} catch (error) {
			console.error('insure_del error:', error);
			newAlert('보험 초기화 중 오류가 발생했습니다.');
		} finally {
			LoadingStop();
		}
		return false;
	}

//-->
</script>

<%- include('../footer_log') %>